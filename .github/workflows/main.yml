name: Backend CI/CD

on:
  push:
    branches:
      - main
      - dev
    paths:
      - "backend/**"
      - "InnoviaHub_Grupp5.sln"
      - ".github/workflows/main.yml"
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      DOTNET_ENVIRONMENT: CI

    steps:
      # 1. Get the code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup .NET
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0"

      # 3. Restore dependencies
      - name: Restore dependencies
        run: dotnet restore InnoviaHub_Grupp5.sln

      # 4. Build the backend
      - name: Build
        run: dotnet build InnoviaHub_Grupp5.sln --configuration Release --no-restore

      # 5. Run tests (optional, can be skipped if tests fail)
      - name: Test
        run: dotnet test backend.Tests/backend.Tests.csproj --configuration Release --no-build --verbosity normal
        continue-on-error: true

      # 6. Publish project (creates a package for deployment)
      - name: Publish
        run: dotnet publish backend/backend.csproj -c Release -o ./publish --no-build

      # 7. List published files (for debugging)
      - name: List published files
        run: |
          echo "Published files:"
          ls -la ./publish/
          echo "---"
          echo "wwwroot files:"
          ls -la ./publish/wwwroot/ 2>/dev/null || echo "No wwwroot directory"

      # 8. Deploy to Azure Web App
      - name: Deploy to Azure WebApp
        uses: azure/webapps-deploy@v3
        with:
          app-name: "InnoviaHub"
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
          package: ./publish
          startup-command: "dotnet backend.dll"
